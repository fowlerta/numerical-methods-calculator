<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Numerical Methods Pro</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2"></script>

  <style>
    body {
      margin: 20px;
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .main-grid {
      max-width: 1400px;
      margin: 0 auto;
    }
    canvas {
      width: 100% !important;
      height: 500px !important;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>

  <h1 style="text-align:center; color:#2c3e50;">Numerical Methods Calculator Pro</h1>
  <p class="subtitle" style="text-align:center; color:#7f8c8d;">
    Root Finding • Interpolation • Differentiation • Integration
  </p>

  <div class="main-grid"
       style="display:grid; grid-template-columns:1fr 1.4fr; gap:30px; margin-top:30px;">

    <!-- INPUT PANEL -->
    <div class="card input-card">
      <h2 style="margin-top:0; color:#2c3e50;">Input</h2>

      <form id="calcForm">
        <label>Function f(x):</label>
        <input type="text" id="function"
               value="x**3 - x - 2"
               placeholder="e.g. sin(x), e**x, x**2 + pi"
               style="width:100%; padding:10px; font-size:16px;">

        <label style="margin-top:15px; display:block;">Method:</label>
        <select id="method" onchange="toggleInputs()"
                style="width:100%; padding:10px; font-size:16px;">
          <option value="newton">Newton-Raphson</option>
          <option value="bisection">Bisection</option>
          <option value="lagrange">Lagrange Interpolation</option>
          <option value="diff">Numerical Differentiation</option>
          <option value="trap">Trapezoidal Rule</option>
          <option value="simpson13">Simpson 1/3 Rule</option>
          <option value="simpson38">Simpson 3/8 Rule</option>
        </select>

        <div id="dynamicInputs" style="margin-top:15px;"></div>

        <!-- Newton Inputs -->
        <div id="newtonInputs" style="display:none; margin-top:15px;">
          <label>Initial guess x₀:</label>
          <input type="number" step="any" id="x0" value="1.5">
        </div>

        <!-- Bisection Inputs -->
        <div id="bisectionInputs" style="display:none; margin-top:15px;">
          <label>Interval [a, b]:</label>
          <div style="display:flex; gap:10px;">
            <input type="number" step="any" id="a" value="1" style="flex:1;">
            <input type="number" step="any" id="b" value="2" style="flex:1;">
          </div>
        </div>

        <label style="margin-top:15px; display:block;">Tolerance:</label>
        <input type="number" step="any" id="tol" value="1e-8">

        <button type="button" onclick="compute()"
                style="margin-top:20px; width:100%; padding:12px;
                       background:#3498db; color:white;
                       border:none; border-radius:8px;
                       font-size:16px; cursor:pointer;">
          Compute
        </button>
      </form>

      <div style="margin-top:25px; font-size:0.9em; color:#666;">
        <strong>Examples:</strong><br><br>
        <button onclick="setFunc('sin(x)')" style="margin:5px; padding:8px 12px;">sin(x)</button>
        <button onclick="setFunc('e**x - 3*x')" style="margin:5px; padding:8px 12px;">e^x - 3x</button>
        <button onclick="setFunc('x**2 + cos(x)')" style="margin:5px; padding:8px 12px;">x² + cos(x)</button>
        <button onclick="setFunc('log(x+3)')" style="margin:5px; padding:8px 12px;">ln(x+3)</button>
      </div>
    </div>

    <!-- OUTPUT PANEL -->
    <div class="card output-card">
      <h2 style="margin-top:0; color:#2c3e50;">Result & Graph</h2>
      <div id="resultText"
           style="margin-bottom:20px; min-height:60px; font-size:16px;">
           Click Compute to begin...
      </div>
      <canvas id="graphCanvas"></canvas>
    </div>

  </div>

<script>
let chart = null;

function setFunc(str) {
  document.getElementById('function').value = str;
}

function toggleInputs() {
  const method = document.getElementById('method').value;
  const dyn = document.getElementById('dynamicInputs');

  document.getElementById('newtonInputs').style.display = 'none';
  document.getElementById('bisectionInputs').style.display = 'none';
  dyn.innerHTML = '';

  if (method === 'newton') {
    document.getElementById('newtonInputs').style.display = 'block';
  }
  else if (method === 'bisection') {
    document.getElementById('bisectionInputs').style.display = 'block';
  }
  else if (['trap', 'simpson13', 'simpson38'].includes(method)) {
    dyn.innerHTML = `
      <label>a:</label><input type="number" step="any" id="a" value="-2">
      <label>b:</label><input type="number" step="any" id="b" value="2">
      <label>n (intervals):</label><input type="number" id="n" value="100" min="2">
    `;
  }
  else if (method === 'lagrange') {
    dyn.innerHTML = `
      <label>X points (comma-separated):</label>
      <input type="text" id="x_points" value="-2,-1,0,1,2">

      <label>Y points (comma-separated):</label>
      <input type="text" id="y_points" value="1,1,0,1,4">

      <label>Evaluate at x:</label>
      <input type="number" step="any" id="x_eval" value="0.5">
    `;
  }
  else if (method === 'diff') {
    dyn.innerHTML = `
      <label>At x:</label><input type="number" step="any" id="x" value="0">
      <label>Method:</label>
      <select id="diff_method">
        <option value="central">Central</option>
        <option value="forward">Forward</option>
        <option value="backward">Backward</option>
      </select>
    `;
  }
}

async function compute() {
  const data = {
    method: document.getElementById('method').value,
    function: document.getElementById('function').value,
    tolerance: document.getElementById('tol').value,
    max_iter: 100
  };

  if (data.method === 'newton') data.x0 = document.getElementById('x0').value;
  if (data.method === 'bisection') {
    data.a = document.getElementById('a').value;
    data.b = document.getElementById('b').value;
  }
  if (['trap', 'simpson13', 'simpson38'].includes(data.method)) {
    data.a = document.getElementById('a').value;
    data.b = document.getElementById('b').value;
    data.n = document.getElementById('n').value;
  }
  if (data.method === 'lagrange') {
    data.x_points = document.getElementById('x_points').value;
    data.y_points = document.getElementById('y_points').value;
    data.x_eval = document.getElementById('x_eval').value;
  }
  if (data.method === 'diff') {
    data.x = document.getElementById('x').value;
    data.diff_method = document.getElementById('diff_method').value;
  }

  const res = await fetch('/compute', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  const result = await res.json();
  displayResult(result);
}

function displayResult(r) {
  const out = document.getElementById('resultText');

  if (r.error) {
    out.innerHTML = `<p style="color:red;"><strong>Error:</strong> ${r.error}</p>`;
    if (chart) chart.destroy();
    return;
  }

  let html = `<h3 style="margin:0 0 10px; color:#2c3e50;">${r.method}</h3>`;

  if (r.root !== undefined)
    html += `<p><strong>Root ≈</strong> ${Number(r.root).toFixed(10)}</p>`;

  if (r.value !== undefined)
    html += `<p><strong>Value ≈</strong> ${Number(r.value).toFixed(10)}</p>`;

  if (r.result !== undefined)
    html += `<p><strong>Integral ≈</strong> ${Number(r.result).toFixed(10)}</p>`;

  out.innerHTML = html;

  drawGraph(r.plot);
}

function drawGraph(plot) {
  if (!plot) return;
  if (chart) chart.destroy();

  const ctx = document.getElementById('graphCanvas').getContext('2d');

  const xyData = plot.x.map((xVal, idx) => ({
    x: xVal,
    y: plot.y[idx]
  }));

  const annotations = {};

  plot.extra.forEach((item, idx) => {
    if (item.type === "point") {
      annotations["p" + idx] = {
        type: "point",
        xValue: item.x,
        yValue: item.y,
        backgroundColor:
          item.label === "Root" ? "#e74c3c" :
          item.label === "P(x)" ? "#9b59b6" : "#3498db",
        radius: item.label === "Root" ? 10 :
                item.label === "P(x)" ? 8 : 6,
        borderColor: "white",
        borderWidth: 3,
        label: {
          enabled: true,
          content: item.label,
          backgroundColor:"rgba(0,0,0,0.7)",
          color:"white",
          font:{size:12},
          yAdjust:-10
        }
      };
    }

    if (item.type === "vline") {
      annotations["v" + idx] = {
        type: "line",
        xMin: item.x,
        xMax: item.x,
        borderColor: "rgba(0,0,0,0.35)",
        borderWidth: 2,
        borderDash: [6,6],
        label:{
          enabled:true,
          content:item.x.toFixed(2)
        }
      };
    }

    if (item.type === "tangent") {
      const span = (plot.x[plot.x.length-1] - plot.x[0]) * 0.15;
      annotations["tangent" + idx] = {
        type: "line",
        xMin: item.x - span,
        xMax: item.x + span,
        yMin: item.y - item.slope * span,
        yMax: item.y + item.slope * span,
        borderColor:"#e67e22",
        borderWidth: 4
      };
      annotations["tangentPoint" + idx] = {
        type: "point",
        xValue: item.x,
        yValue: item.y,
        backgroundColor:"#e67e22",
        radius:9,
        borderColor:"white",
        borderWidth:3
      };
    }
  });

  chart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label: "f(x)",
        data: xyData,
        borderColor: "#3498db",
        backgroundColor: "rgba(52,152,219,0.2)",
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: "linear",
          title: { display: true, text: "x" }
        },
        y: {
          type: "linear",
          title: { display: true, text: "f(x)" }
        }
      },
      plugins: {
        annotation: { annotations },
        legend: { display: false }
      }
    }
  });
}

toggleInputs();
</script>
</body>
</html>
